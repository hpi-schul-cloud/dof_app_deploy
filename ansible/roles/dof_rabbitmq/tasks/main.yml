  - name: RabbitMQ onepassword
    kubernetes.core.k8s:
      kubeconfig: ~/.kube/config
      namespace: "{{ NAMESPACE }}"
      template: onepassword.yaml.j2
    when: ONEPASSWORD_OPERATOR is defined and ONEPASSWORD_OPERATOR|bool
    tags:
      - 1password

  - name: RabbitMQ secret
    kubernetes.core.k8s:
      kubeconfig: ~/.kube/config
      namespace: "{{ NAMESPACE }}"
      template: secret.yaml.j2
      apply: yes
    when: ONEPASSWORD_OPERATOR is undefined or ONEPASSWORD_OPERATOR is defined and not ONEPASSWORD_OPERATOR
    tags:
      - secret


  - name: RabbitMQ Cluster
    kubernetes.core.k8s:
      kubeconfig: ~/.kube/config 
      namespace: "{{ NAMESPACE }}"
      template: rabbitmq.yaml.j2
    tags:
      - deployment

  - name: Service Monitor
    kubernetes.core.k8s:
      kubeconfig: ~/.kube/config
      namespace: "{{ NAMESPACE }}"
      template: templates/rabbitmq-svc-monitor.yml.j2
    when: RABBITMQ_SERVICE_MONITOR is undefined or RABBITMQ_SERVICE_MONITOR is defined and not RABBITMQ_SERVICE_MONITOR
    tags:
      - prometheus


  - name: Get RabbitMQ pods in the namespace
    kubernetes.core.k8s_info:
      api_version: v1
      kind: Pod
      namespace: "{{ NAMESPACE }}"
      label_selectors:
        - app.kubernetes.io/component=rabbitmq
    register: rabbitmq_pods

  - name: Enable RabbitMQ feature flags in all pods
    kubernetes.core.k8s_exec:
      namespace: "{{ NAMESPACE }}"
      pod: "{{ item.metadata.name }}"
      container: rabbitmq
      command: "rabbitmqctl list_feature_flags"
    with_items: "{{ rabbitmq_pods.resources }}"
    register: exec_results

  - name: Debug the output of k8s_exec results
    debug:
      msg: |
        Pod: {{ item.item.metadata.name }}
        Standard Output: {{ item.stdout }}
        Standard Error: {{ item.stderr }}
        Return Code: {{ item.rc }}
    with_items: "{{ exec_results.results }}"
