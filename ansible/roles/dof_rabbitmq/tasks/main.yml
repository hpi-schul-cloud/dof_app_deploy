  - name: RabbitMQ onepassword
    kubernetes.core.k8s:
      kubeconfig: ~/.kube/config
      namespace: "{{ NAMESPACE }}"
      template: onepassword.yaml.j2
    when: ONEPASSWORD_OPERATOR is defined and ONEPASSWORD_OPERATOR|bool
    tags:
      - 1password

  - name: RabbitMQ secret
    kubernetes.core.k8s:
      kubeconfig: ~/.kube/config
      namespace: "{{ NAMESPACE }}"
      template: secret.yaml.j2
      apply: yes
    when: ONEPASSWORD_OPERATOR is undefined or ONEPASSWORD_OPERATOR is defined and not ONEPASSWORD_OPERATOR
    tags:
      - secret


  - name: RabbitMQ Cluster
    kubernetes.core.k8s:
      kubeconfig: ~/.kube/config 
      namespace: "{{ NAMESPACE }}"
      template: rabbitmq.yaml.j2
    tags:
      - deployment

  - name: Service Monitor
    kubernetes.core.k8s:
      kubeconfig: ~/.kube/config
      namespace: "{{ NAMESPACE }}"
      template: templates/rabbitmq-svc-monitor.yml.j2
    when: RABBITMQ_SERVICE_MONITOR is undefined or RABBITMQ_SERVICE_MONITOR is defined and not RABBITMQ_SERVICE_MONITOR
    tags:
      - prometheus

  - name: Enable all RabbitMQ feature flags in all pods
    kubernetes.core.k8s_exec:
      namespace: "{{ NAMESPACE }}"
      pod: "{{ item }}"
      container: rabbitmq
      command:
        - bash
        - -c
        - |
          rabbitmqctl enable_feature_flag_all
    loop: "{{ query('kubernetes.core.k8s_info', {'api_version': 'v1', 'kind': 'Pod', 'namespace': namespace, 'label_selectors': ['app.kubernetes.io/name=rabbitmq']}).resources | map(attribute='metadata.name') | list }}"
    register: exec_results

  - name: Display results of feature flag enablement
    debug:
      msg: "Pod: {{ item.item }} - {{ item.stdout }}"
    with_items: "{{ exec_results.results }}"
