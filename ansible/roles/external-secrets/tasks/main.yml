---
  - name: Create Secret with Token for SecretStore
    vars:
      secretstore-token: "{{ query('kubernetes.core.k8s', kind='Secret', namespace=EXTERNAL_SECRETS_NAMESPACE, resource_name=EXTERNAL_SECRETS_TOKEN_SECRET, kubeconfig=kubeconfig)[0].data.token }}"
    kubernetes.core.k8s:
      kubeconfig: ~/.kube/config
      template: secret-token.yml.j2
    when: EXTERNAL_SECRETS_OPERATOR

  - name: Delete Secret with Token for SecretStore
    kubernetes.core.k8s:
      kubeconfig: ~/.kube/config
      namespace: "{{ NAMESPACE }}"
      kind: Secret
      name: external-secrets-secretstore-token
      state: absent
    when: not EXTERNAL_SECRETS_OPERATOR

  - name: Create Secret Store
    kubernetes.core.k8s:
      kubeconfig: ~/.kube/config
      template: secretstore.yml.j2
    when: EXTERNAL_SECRETS_OPERATOR
