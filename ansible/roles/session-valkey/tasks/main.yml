- name: Secret for schulcloud valkey
  kubernetes.core.k8s:
    kubeconfig: ~/.kube/config
    namespace: '{{ NAMESPACE }}'
    template: onepassword.yml.j2
  when: ONEPASSWORD_OPERATOR is defined and ONEPASSWORD_OPERATOR|bool
  tags:
    - 1password

- name: External Secret session-valkey-config
  kubernetes.core.k8s:
    kubeconfig: ~/.kube/config
    namespace: "{{ NAMESPACE }}"
    template: es-session-valkey-config.yml.j2
  when: EXTERNAL_SECRETS_OPERATOR
  tags:
    - 1password

- name: External Secret session-valkey-sentinel-config
  kubernetes.core.k8s:
    kubeconfig: ~/.kube/config
    namespace: "{{ NAMESPACE }}"
    template: es-session-valkey-sentinel-config.yml.j2
  when: EXTERNAL_SECRETS_OPERATOR
  tags:
    - 1password

- name: External Secret session-valkey-exporter
  kubernetes.core.k8s:
    kubeconfig: ~/.kube/config
    namespace: "{{ NAMESPACE }}"
    template: es-session-valkey-exporter.yml.j2
  when: EXTERNAL_SECRETS_OPERATOR
  tags:
    - 1password

- name: Install valkey sentinel
  kubernetes.core.helm:
    chart_repo_url: "https://groundhog2k.github.io/helm-charts/"
    chart_ref: valkey
    chart_version: '{{ SESSION_VALKEY_CHART_VERSION }}'
    release_name: session
    release_namespace: '{{ NAMESPACE }}'
    release_state: present
    create_namespace: yes
    kubeconfig: ~/.kube/config
    update_repo_cache: no
    values: "{{ lookup('template', 'values.yml.j2') | from_yaml }}"
  tags:
    - helm