- name: Add or Update Postgres Cluster Secret by 1Password
  kubernetes.core.k8s:
    kubeconfig: ~/.kube/config 
    namespace: "{{ NAMESPACE }}"
    template: onepassword-pg-cluster.yml.j2
  when: WITH_BRANCH_POSTGRES_DB_MANAGEMENT and (ONEPASSWORD_OPERATOR is defined and ONEPASSWORD_OPERATOR|bool)

- name: Check if secret with database credentials already exists
  kubernetes.core.k8s_info:
    kubeconfig: ~/.kube/config
    namespace: "{{ NAMESPACE }}"
    kind: Secret
    name: "pg-{{ item }}-secret"
  register: db_secret_present
  loop: "{{ POSTGRES_DATABASES }}"
  when: WITH_BRANCH_POSTGRES_DB_MANAGEMENT

- name: Create Secrets for the databases (if not existing)
  kubernetes.core.k8s:
    kubeconfig: ~/.kube/config
    namespace: "{{ NAMESPACE }}"
    template: secret-database.yml.j2
  loop: "{{ db_secret_present.results }}"
  when: WITH_BRANCH_POSTGRES_DB_MANAGEMENT and item.resources|length == 0

- name: Create ConfigMap with Script
  kubernetes.core.k8s:
    kubeconfig: ~/.kube/config
    namespace: "{{ NAMESPACE }}"
    template: configmap-database-init.yml.j2
    apply: yes
  loop: "{{ POSTGRES_DATABASES }}"
  when: WITH_BRANCH_POSTGRES_DB_MANAGEMENT

- name: Create/execute database configuration script
  kubernetes.core.k8s:
    kubeconfig: ~/.kube/config 
    namespace: "{{ NAMESPACE }}"
    template: job-database-init.yml.j2
  loop: "{{ POSTGRES_DATABASES }}"
  when: WITH_BRANCH_POSTGRES_DB_MANAGEMENT