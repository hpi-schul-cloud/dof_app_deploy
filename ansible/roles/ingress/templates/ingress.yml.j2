#jinja2: trim_blocks: "True", lstrip_blocks: "True"
apiVersion: networking.k8s.io/v1beta1
kind: Ingress
metadata:
  name: {{ NAMESPACE }}-ingress
  namespace: {{ NAMESPACE }}
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/ssl-redirect: "false"

spec:
  rules:
  - host: {{ DOMAIN }}
    http:
      paths:
      ### Client / Nuxtclient
      - path: /
        backend:
          serviceName: client-svc
          servicePort: {{ CLIENT_PORT }}

      - path: /themes/{{ SC_THEME }}/favicon.png
        backend:
          serviceName: nuxtclient-svc
          servicePort: {{ NUXTCLIENT_PORT }}
      - path: /account
        backend:
          serviceName: nuxtclient-svc
          servicePort: {{ NUXTCLIENT_PORT }}
      - path: /activation
        backend:
          serviceName: nuxtclient-svc
          servicePort: {{ NUXTCLIENT_PORT }}
      - path: /administration/ldap
        backend:
          serviceName: nuxtclient-svc
          servicePort: {{ NUXTCLIENT_PORT }}
      - path: /metrics
        backend:
          serviceName: default-backend-404-svc
          servicePort: 8080
      - path: /login-instances
        backend:
          serviceName: nuxtclient-svc
          servicePort: {{ NUXTCLIENT_PORT }}
      - path: /login
        backend:
      {% if WITH_LDAP_SEPERATION is defined and WITH_LDAP_SEPERATION %}
          serviceName: client-ldap-svc
      {% else %}
          serviceName: client-svc
      {% endif %}
          servicePort: {{ CLIENT_PORT }}
      - path: /login/success
        backend:
          serviceName: client-svc
          servicePort: {{ CLIENT_PORT }}
      - path: /error
        backend:
          serviceName: nuxtclient-svc
          servicePort: {{ NUXTCLIENT_PORT }}
      - path: /imprint
        backend:
          serviceName: nuxtclient-svc
          servicePort: {{ NUXTCLIENT_PORT }}
      - path: /termsofuse
        backend:
          serviceName: nuxtclient-svc
          servicePort: {{ NUXTCLIENT_PORT }}
      - path: /mint-ec
        backend:
          serviceName: nuxtclient-svc
          servicePort: {{ NUXTCLIENT_PORT }}
      - path: /insights
        backend:
          serviceName: nuxtclient-svc
          servicePort: {{ NUXTCLIENT_PORT }}
      - path: /news
        backend:
          serviceName: nuxtclient-svc
          servicePort: {{ NUXTCLIENT_PORT }}
      - path: /tasks/open
        backend:
          serviceName: nuxtclient-svc
          servicePort: {{ NUXTCLIENT_PORT }}
      - path: /tasks/assigned
        backend:
          serviceName: nuxtclient-svc
          servicePort: {{ NUXTCLIENT_PORT }}
      - path: /nuxtversion
        backend:
          serviceName: nuxtclient-svc
          servicePort: {{ NUXTCLIENT_PORT }}
      - path: /content
        backend:
          serviceName: nuxtclient-svc
          servicePort: {{ NUXTCLIENT_PORT }}
      - path: /_nuxt
        backend:
          serviceName: nuxtclient-svc
          servicePort: {{ NUXTCLIENT_PORT }}
      - path: /systems/ldap
        backend:
      {% if WITH_LDAP_SEPERATION is defined and WITH_LDAP_SEPERATION %}
          serviceName: nuxtclient-ldap-svc
      {% else %}
          serviceName: nuxtclient-svc
      {% endif %}
          servicePort: {{ NUXTCLIENT_PORT }}
      - path: /administration/systems/ldap
        backend:
      {% if WITH_LDAP_SEPERATION is defined and WITH_LDAP_SEPERATION %}
          serviceName: nuxtclient-ldap-svc
      {% else %}
          serviceName: nuxtclient-svc
      {% endif %}
          servicePort: {{ NUXTCLIENT_PORT }}
      - path: /administration/school-settings
        backend:
          serviceName: nuxtclient-svc
          servicePort: {{ NUXTCLIENT_PORT }}

      {% if ROUTE_NUXTCLIENT_ADMINISTRATION_DATASOURCES is defined and ROUTE_NUXTCLIENT_ADMINISTRATION_DATASOURCES %}
      - path: /administration/datasources
        backend:
          serviceName: nuxtclient-svc
          servicePort: {{ NUXTCLIENT_PORT }}
      {% endif %}

      {% if ROUTE_NUXTCLIENT_ADMINISTRATION_STUDENTS is defined and ROUTE_NUXTCLIENT_ADMINISTRATION_STUDENTS %}
      - path: /administration/students/
        backend:
          serviceName: nuxtclient-svc
          servicePort: {{ NUXTCLIENT_PORT }}
      {% endif %}

      {% if ROUTE_NUXTCLIENT_ADMINISTRATION_TEACHERS is defined and ROUTE_NUXTCLIENT_ADMINISTRATION_TEACHERS %}
      - path: /administration/teachers/
        backend:
          serviceName: nuxtclient-svc
          servicePort: {{ NUXTCLIENT_PORT }}
      {% endif %}
      ### Etherpad
      - path: /etherpad
        backend:
          serviceName: etherpad-nginx-svc
          servicePort: 80
      - path: /etherpad/socket.io
        backend:
          serviceName: etherpad-nginx-svc
          servicePort: 80
      ### Server
      - path: /api
        backend:
          serviceName: default-backend-404-svc
          servicePort: 8080
      - path: /api/v1/metrics
        backend:
          serviceName: default-backend-404-svc
          servicePort: 8080
        pathType: Prefix
      {% if ROUTE_ACCOUNTS is defined and ROUTE_ACCOUNTS %}
      - path: /api/v1/accounts
        backend:
          serviceName: api-svc
          servicePort: {{ PORT_SERVER }}
      {% endif %}
      - path: /api/v1/accounts/jwtTimer
        backend:
          serviceName: api-svc
          servicePort: {{ PORT_SERVER }}
      - path: /api/v1/edu-sharing
        backend:
          serviceName: api-svc
          servicePort: {{ PORT_SERVER }}
      - path: /api/v1/me
        backend:
          serviceName: api-svc
          servicePort: {{ PORT_SERVER }}
      - path: /api/v3/tasks/
        backend:
          serviceName: api-svc
          servicePort: {{ PORT_SERVER }}
      - path: /api/v3/user/me
        backend:
          serviceName: api-svc
          servicePort: {{ PORT_SERVER }}
      - path: /api/v3/news
        backend:
          serviceName: api-svc
          servicePort: {{ PORT_SERVER }}
      {% if ROUTE_ROSTER is defined and ROUTE_ROSTER %}
      # Route /roster is used by bettermarks
      - path: /api/v1/roster
        backend:
          serviceName: api-svc
          servicePort: {{ PORT_SERVER }}
      - path: /api/roster
        backend:
          serviceName: api-svc
          servicePort: {{ PORT_SERVER }}
      {% endif %}
      - path: /api/v1/schools/
        backend:
          serviceName: api-svc
          servicePort: {{ PORT_SERVER }}
      - path: /api/v1/years/
        backend:
          serviceName: api-svc
          servicePort: {{ PORT_SERVER }}
      - path: /api/v1/federalStates
        backend:
          serviceName: api-svc
          servicePort: {{ PORT_SERVER }}
      - path: /api/v1/systems
        backend:
          serviceName: api-svc
          servicePort: {{ PORT_SERVER }}
      - path: /api/v1/ldap-config
        backend:
          serviceName: api-svc
          servicePort: {{ PORT_SERVER }}
      # todo remove when updated to be used with version:
      - path: /api/version
        backend:
          serviceName: api-svc
          servicePort: {{ PORT_SERVER }}
      - path: /api/v1/version
        backend:
          serviceName: api-svc
          servicePort: {{ PORT_SERVER }}
      - path: /api/v1/wopi
        backend:
          serviceName: api-svc
          servicePort: {{ PORT_SERVER }}
      - path: /api/v1/courses
        backend:
          serviceName: api-svc
          servicePort: {{ PORT_SERVER }}
      - path: /api/v1/lessons
        backend:
          serviceName: api-svc
          servicePort: {{ PORT_SERVER }}
      - path: /api/v1/authentication
        backend:
      {% if WITH_LDAP_SEPERATION is defined and WITH_LDAP_SEPERATION %}
          serviceName: api-ldap-svc
      {% else %}
          serviceName: api-svc
      {% endif %}
          servicePort: {{ PORT_SERVER }}
      - path: /api/v1/sync
        backend:
          serviceName: api-svc
          servicePort: {{ PORT_SERVER }}
      - path: /api/v1/ldap
        backend:
      {% if WITH_LDAP_SEPERATION is defined and WITH_LDAP_SEPERATION %}
          serviceName: api-ldap-svc
      {% else %}
          serviceName: api-svc
      {% endif %}
          servicePort: {{ PORT_SERVER }}
      - path: /api/v1/registration
        pathType: Prefix
        backend:
      {% if NAMESPACE == 'niedersachsen' %}
          serviceName: default-backend-404-svc
          servicePort: 8080
      {% elif WITH_LDAP_SEPERATION is defined and WITH_LDAP_SEPERATION %}
          serviceName: api-ldap-svc
          servicePort: {{ PORT_SERVER }}
      {% else %}
          serviceName: api-svc
          servicePort: {{ PORT_SERVER }}
      {% endif %}
      {% if ROUTE_USERS is defined and ROUTE_USERS %}
      - path: /api/v1/users
        backend:
          serviceName: api-svc
          servicePort: {{ PORT_SERVER }}
      {% endif %}
      {% if ROUTE_CLASSES is defined and ROUTE_CLASSES %}
      - path: /api/v1/classes
        backend:
          serviceName: api-svc
          servicePort: {{ PORT_SERVER }}
      {% endif %}
      - path: /api/v1/roles/user
        backend:
          serviceName: api-svc
          servicePort: {{ PORT_SERVER }}
      - path: /api/v1/config/app/public
        backend:
          serviceName: api-svc
          servicePort: {{ PORT_SERVER }}
