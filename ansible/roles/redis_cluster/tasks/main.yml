  - name: Add bitnami chart repo
    kubernetes.core.helm_repository:
      name: bitnamicharts
      repo_url: "https://charts.bitnami.com/bitnami"
    delegate_to: localhost
    changed_when: false
    when: WITH_REDIS_CLUSTER

  - name: redis cluster
    kubernetes.core.helm:
      name: "{{ REDISCLUSTER_LABEL }}"
      chart_ref: bitnamicharts/redis-cluster
      update_repo_cache: yes
      wait: no
      chart_version: "{{ REDISCLUSTER_CHART_VERSION }}"
      kubeconfig: ~/.kube/config
      release_namespace: "{{ NAMESPACE }}"
      values: "{{ lookup('template', 'values.yaml.j2') | from_yaml }}"
    when: WITH_REDIS_CLUSTER
