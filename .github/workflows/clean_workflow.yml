---
name: Clean Out Branches

on:
  workflow_call:
    inputs:
      branch:
        required: true
        type: string
      user_name:
         required: false
         default: hpi-schul-clud-bot
         type: string
      user_email:
         required: false
         default: bot@hpi-schul-cloud.de
         type: string
    secrets:
      token:
        required: true
      DEV_KUBE_CONFIG:
        required: true

permissions:
  contents: read

jobs:
  create_branch_identifier:
    uses: ./.github/workflows/branch-to-namespace.yml
    with:
      branch: ${{ inputs.branch }}

  gather_branch_exists:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        repo:
          - schulcloud-server
          - schulcloud-client
          - nuxt-client
          - superhero-dashboard
          - schulcloud-calendar
          - antivirus_check_service
          - version-aggregator
          - dof_app_deploy
    steps:
      - run: |
          echo "git_ref_name=${{ inputs.branch }}" >> $GITHUB_ENV
          echo git_ref_name ${{ inputs.branch }}
      - uses: actions/checkout@v3
        with:
          repository: hpi-schul-cloud/${{ matrix.repo }}
          token: ${{ secrets.token }}
          path: ${{ matrix.repo }}
          fetch-depth: 0
      - name: Add Flag for existing branch
        working-directory: ${{github.workspace }}/${{ matrix.repo }}
        shell: bash
        run: |
          if git rev-parse --quiet --verify ${{ env.git_ref_name }} > /dev/null; then
            echo "${{ matrix.repo }}=true" >> $GITHUB_ENV
          else
            echo "${{ matrix.repo }}=false" >> $GITHUB_ENV

  delete:
    runs-on: ubuntu-latest
    needs: gather_branch_exists
    steps:
      - name: are_all_branches_deleted
        id: are_all_branches_deleted
        run: |
          existing_branches=$(echo '${{ toJSON(gather_branch_exists.outputs) }}' | jq '.gather_branch_exists.outputs | del(..|select(. == "false"))') 
          echo "repos with existing branches are: $existing_branches"
          if [ $(echo $existing_branches | jq 'length') == "0" ]; then;
            echo "no branches left";
             echo "are_all_branches_deleted=true" >> $GITHUB_ENV
          else
             echo "are_all_branches_deleted=false" >> $GITHUB_ENV

  bingo_delete_branch:
    if: ${{ needs.delete.outputs.are_all_branches_deleted }} == 'true'
    needs:
      - delete
      - create_branch_identifier
    uses: hpi-schul-cloud/dof_bingo/.github/workflows/remove-branch.yml@main
    with:
      branch: ${{ needs.create_branch_identifier.outputs.id_branch }}
    secrets:
      bingo_token: ${{ secrets.BINGO_TOKEN }}

  create_artifacts_repos:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        repo:
          - schulcloud-server
          - schulcloud-client
          - nuxt-client
          - superhero-dashboard
          - schulcloud-calendar
          - antivirus_check_service
          - version-aggregator
          - dof_app_deploy
    steps:
      - run: |
          echo "git_ref_name=${{ inputs.branch }}" >> $GITHUB_ENV
          echo git_ref_name ${{ inputs.branch }}
      - uses: actions/checkout@v3
        with:
          repository: hpi-schul-cloud/${{ matrix.repo }}
          token: ${{ secrets.token }}
          path: ${{ matrix.repo }}
          fetch-depth: 0
      - name: Add Flag for existing branch
        working-directory: ${{github.workspace }}/${{ matrix.repo }}
        shell: bash
        run: | 
          if git rev-parse --quiet --verify ${{ env.git_ref_name }} > /dev/null; then
            echo "BRANCH_EXIST: true" > ansible/group_vars/all/${{ matrix.repo }}.yml
          fi
      - run: tar -cf ${{ matrix.repo }}.tar ansible
        working-directory: ${{github.workspace }}/${{ matrix.repo }}
      - uses: actions/upload-artifact@v3
        with:
          name: ${{ matrix.repo }}
          path: ${{github.workspace }}/${{ matrix.repo }}/${{ matrix.repo }}.tar
          
  create_artifacts_workspaces:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        tennens: [ brb, default, nbc ]
    steps:
      - run: |
          echo "git_ref_name=${{ inputs.branch }}" >> $GITHUB_ENV
          echo git_ref_name ${{ inputs.branch }}
      - shell: bash
        id: make_identifier
        run: |
          mkdir -pv ansible/group_vars/${{ matrix.tennens }}
          
          temp=$(echo $git_ref_name | sed 's@.*/@@' | tr [A-Z] [a-z] | tr _ - | tr \. -)
          echo "before" $git_ref_name "after" $temp
          echo "id=$temp" >> $GITHUB_OUTPUT
      - shell: bash
        working-directory: ${{github.workspace }}/ansible/group_vars/${{ matrix.tennens }}
        run: |
          echo "NAMESPACE: ${{ matrix.tennens }}-${{ steps.make_identifier.outputs.id }}" > cfg.yml
      - run: tar -cf ${{ matrix.tennens }}.tar ansible
      - uses: actions/upload-artifact@v3
        with:
          name: ${{ matrix.tennens }}
          path: ${{github.workspace }}/${{ matrix.tennens }}.tar
  
  clean_cluster:
    needs: 
      - create_artifacts_repos
      - create_artifacts_workspaces
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v3
      - run: mv */*.tar ./
      - run: find -name "*.tar" -exec tar -xf {} \;
      - run: tar -cf ansible.tar ansible
      - uses: actions/upload-artifact@v3
        with:
          name: ansible
          path: ${{github.workspace }}/ansible.tar
      - shell: bash
        run: |
          python3 -m pip install openshift
          
      - run: ansible-galaxy collection install community.kubernetes:1.2.1
      - working-directory: ${{github.workspace }}/ansible/roles/clean
        run: |
          mkdir files
          echo "${{ secrets.DEV_KUBE_CONFIG }}" > files/config
      - run: ansible-playbook ./playbook_clean.yml --inventory-file hosts -e 'ansible_python_interpreter=/usr/bin/python3'
        working-directory: ${{github.workspace }}/ansible
      - working-directory: ${{github.workspace }}/ansible/roles/clean/files
        run: |
          rm -rf  /config
