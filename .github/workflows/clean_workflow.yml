---
name: Clean Out Branches

on:
  workflow_call:
    inputs:
      branch:
        required: true
        type: string
      user_name:
         required: false
         default: hpi-schul-clud-bot
         type: string
      user_email:
         required: false
         default: bot@hpi-schul-cloud.de
         type: string
    secrets:
      token:
        required: true
      DEV_KUBE_CONFIG:
        required: true

permissions:
  contents: read

jobs:
  create_branch_identifier:
    uses: ./.github/workflows/branch-to-namespace.yml
    with:
      branch: ${{ inputs.branch }}

  delete_namespaces:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        repo:
          - schulcloud-server
          - schulcloud-client
          - nuxt-client
          - superhero-dashboard
          - schulcloud-calendar
          - antivirus_check_service
          - version-aggregator
          - dof_app_deploy
    steps:
      - run: |
          echo "git_ref_name=${{ inputs.branch }}" >> $GITHUB_ENV
          echo git_ref_name ${{ inputs.branch }}
      - uses: actions/checkout@v3
        with:
          repository: hpi-schul-cloud/${{ matrix.repo }}
          token: ${{ secrets.token }}
          path: ${{ matrix.repo }}
          fetch-depth: 0
      - name: Add Flag for existing branch
        id: gather_branch_exists
        working-directory: ${{github.workspace }}/${{ matrix.repo }}
        shell: bash
        run: |
          if git rev-parse --quiet --verify ${{ env.git_ref_name }} > /dev/null; then
            echo "${{ matrix.repo }}=true" >> $GITHUB_ENV
          else
            echo "${{ matrix.repo }}=false" >> $GITHUB_ENV



