name: Rollout to the instances

on:
  workflow_dispatch:
    inputs:
      config_tag_name:
        description: 'Tag from the dof_app_deploy'
        required: true
      instance_group:
        description: "All Instances, Instance group or Host"
        required: true
        default: all

jobs:
  approve_ref:
    environment: approve_ref
    runs-on: ubuntu-latest
    steps:
      - run: echo " ${{ github.event.inputs.config_tag_name }}"
      
  ref-audit:
    needs:
      - approve_ref
    uses: hpi-schul-cloud/dof_app_deploy/.github/workflows/host.yml@main
    with:
      cfg_version: ${{ github.event.inputs.config_tag_name }}
      host_name: ref-audit
      host_group: default
      host_stage: reference
      execute_group: ${{ github.event.inputs.instance_group }}
    secrets:
      token: ${{ secrets.GITHUB_TOKEN }}
      ONEPASSWORD_VAULT: ${{ secrets.ONEPASSWORD_VAULT }}
      ETHERPAD_API_KEY: ${{ secrets.ETHERPAD_API_KEY }}
      KUBECONFIG: ${{ secrets.KUBECONFIG }}
      
  ref-brb:
    needs:
      - approve_ref
    uses: hpi-schul-cloud/dof_app_deploy/.github/workflows/host.yml@main
    with:
      cfg_version: ${{ github.event.inputs.config_tag_name }}
      host_name: ref-brb
      host_group: brb
      host_stage: reference
      execute_group: ${{ github.event.inputs.instance_group }}
    secrets:
      token: ${{ secrets.GITHUB_TOKEN }}
      ONEPASSWORD_VAULT: ${{ secrets.ONEPASSWORD_VAULT }}
      ETHERPAD_API_KEY: ${{ secrets.ETHERPAD_API_KEY }}
      KUBECONFIG: ${{ secrets.KUBECONFIG }}
      
  ref-dbc:
    needs:
      - approve_ref
    uses: hpi-schul-cloud/dof_app_deploy/.github/workflows/host.yml@main
    with:
      cfg_version: ${{ github.event.inputs.config_tag_name }}
      host_name: ref-dbc
      host_group: default
      host_stage: reference
      execute_group: ${{ github.event.inputs.instance_group }}
    secrets:
      token: ${{ secrets.GITHUB_TOKEN }}
      ONEPASSWORD_VAULT: ${{ secrets.ONEPASSWORD_VAULT }}
      ETHERPAD_API_KEY: ${{ secrets.ETHERPAD_API_KEY }}
      KUBECONFIG: ${{ secrets.KUBECONFIG }}
      
  ref-int:
    needs:
      - approve_ref
    uses: hpi-schul-cloud/dof_app_deploy/.github/workflows/host.yml@main
    with:
      cfg_version: ${{ github.event.inputs.config_tag_name }}
      host_name: ref-int
      host_group: international
      host_stage: reference
      execute_group: ${{ github.event.inputs.instance_group }}
    secrets:
      token: ${{ secrets.GITHUB_TOKEN }}
      ONEPASSWORD_VAULT: ${{ secrets.ONEPASSWORD_VAULT }}
      ETHERPAD_API_KEY: ${{ secrets.ETHERPAD_API_KEY }}
      KUBECONFIG: ${{ secrets.KUBECONFIG }}
      

  ref-thr:
    needs:
     - approve_ref
    uses: hpi-schul-cloud/dof_app_deploy/.github/workflows/host.yml@main
    with:
      cfg_version: ${{ github.event.inputs.config_tag_name }}
      host_name: ref-thr
      host_group: thr
      host_stage: reference
      execute_group: ${{ github.event.inputs.instance_group }}
    secrets:
      token: ${{ secrets.GITHUB_TOKEN }}
      ONEPASSWORD_VAULT: ${{ secrets.ONEPASSWORD_VAULT }}
      ETHERPAD_API_KEY: ${{ secrets.ETHERPAD_API_KEY }}
      KUBECONFIG: ${{ secrets.KUBECONFIG }}

  approve_prod_stage_1:
    if: ${{ !failure() }}
    needs:
      - ref-brb
      - ref-dbc
      - ref-int
      - ref-nbc
      - ref-thr
    environment: approve_prod_stage_1
    runs-on: ubuntu-latest
    steps:
      - run: echo " ${{ github.event.inputs.config_tag_name }}"
      
  prod-dbc:
    needs:
      - approve_prod_stage_1
    uses: hpi-schul-cloud/dof_app_deploy/.github/workflows/host.yml@main
    with:
      cfg_version: ${{ github.event.inputs.config_tag_name }}
      host_name: prod-dbc
      host_group: default
      host_stage: production
      execute_group: ${{ github.event.inputs.instance_group }}
    secrets:
      token: ${{ secrets.GITHUB_TOKEN }}
      ONEPASSWORD_VAULT: ${{ secrets.ONEPASSWORD_VAULT }}
      ETHERPAD_API_KEY: ${{ secrets.ETHERPAD_API_KEY }}
      KUBECONFIG: ${{ secrets.KUBECONFIG }}
      
  approve_prod_stage_2:
    needs:
      - prod-dbc
    environment: approve_prod_stage_2
    runs-on: ubuntu-latest
    steps:
      - run: echo " ${{ github.event.inputs.config_tag_name }}"
      
  prod-brb:
    needs:
      - approve_prod_stage_2
    uses: hpi-schul-cloud/dof_app_deploy/.github/workflows/host.yml@main
    with:
      cfg_version: ${{ github.event.inputs.config_tag_name }}
      host_name: prod-brb
      host_group: brb
      host_stage: production
      execute_group: ${{ github.event.inputs.instance_group }}
    secrets:
      token: ${{ secrets.GITHUB_TOKEN }}
      ONEPASSWORD_VAULT: ${{ secrets.ONEPASSWORD_VAULT }}
      ETHERPAD_API_KEY: ${{ secrets.ETHERPAD_API_KEY }}
      KUBECONFIG: ${{ secrets.KUBECONFIG }}
#      
#  prod-demo:
#    needs:
#      - approve_prod_stage_2
#    uses: hpi-schul-cloud/dof_app_deploy/.github/workflows/host.yml@main
#    with:
#      cfg_version: ${{ github.event.inputs.config_tag_name }}
#      host_name: prod-demo
#      host_group: default
#      host_stage: production
#      execute_group: ${{ github.event.inputs.instance_group }}
#    secrets:
#      token: ${{ secrets.GITHUB_TOKEN }}
#      ONEPASSWORD_VAULT: ${{ secrets.ONEPASSWORD_VAULT }}
#      ETHERPAD_API_KEY: ${{ secrets.ETHERPAD_API_KEY }}
#      KUBECONFIG: ${{ secrets.KUBECONFIG }}
#  
  prod-int:
    needs:
      - approve_prod_stage_2
    uses: hpi-schul-cloud/dof_app_deploy/.github/workflows/host.yml@main
    with:
      cfg_version: ${{ github.event.inputs.config_tag_name }}
      host_name: prod-int
      host_group: international
      host_stage: production
      execute_group: ${{ github.event.inputs.instance_group }}
    secrets:
      token: ${{ secrets.GITHUB_TOKEN }}
      ONEPASSWORD_VAULT: ${{ secrets.ONEPASSWORD_VAULT }}
      ETHERPAD_API_KEY: ${{ secrets.ETHERPAD_API_KEY }}
      KUBECONFIG: ${{ secrets.KUBECONFIG }}
  
#      
#  prod-thr:
#    needs:
#      - approve_prod_stage_2
#    uses: hpi-schul-cloud/dof_app_deploy/.github/workflows/host.yml@main
#    with:
#      cfg_version: ${{ github.event.inputs.config_tag_name }}
#      host_name: prod-thr
#      host_group: thr
#      host_stage: production
#      execute_group: ${{ github.event.inputs.instance_group }}
#    secrets:
#      token: ${{ secrets.GITHUB_TOKEN }}
#      ONEPASSWORD_VAULT: ${{ secrets.ONEPASSWORD_VAULT }}
#      ETHERPAD_API_KEY: ${{ secrets.ETHERPAD_API_KEY }}
#      KUBECONFIG: ${{ secrets.KUBECONFIG }}

  test-loadtest-01:
    uses: hpi-schul-cloud/dof_app_deploy/.github/workflows/host.yml@main
    with:
      cfg_version: ${{ github.event.inputs.config_tag_name }}
      host_name: test-loadtest-01
      host_group: default
      host_stage: test
      execute_group: ${{ github.event.inputs.instance_group }}
    secrets:
      token: ${{ secrets.GITHUB_TOKEN }}
      ONEPASSWORD_VAULT: ${{ secrets.ONEPASSWORD_VAULT }}
      ETHERPAD_API_KEY: ${{ secrets.ETHERPAD_API_KEY }}
      KUBECONFIG: ${{ secrets.KUBECONFIG }}