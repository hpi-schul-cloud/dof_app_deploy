---
name: Build and push Docker Image

on:
  repository_dispatch:
    types: [dev-deploy]

jobs:
  create_artifacts:
    runs-on: ubuntu-18.04
    strategy:
      matrix:
        repos: [ dof_test_app_1, dof_test_app_2 ]
    steps:
      - uses: actions/checkout@v2
        with:
          repository: hpi-schul-cloud/${{ matrix.repos }}
          token: ${{ secrets.REPO_ACCESS_TOKEN }}
          path: ${{ matrix.repos }}
          fetch-depth: 0
      - run: git checkout ${{ github.event.client_payload.branch }}
        working-directory: ${{github.workspace }}/${{ matrix.repos }}
        continue-on-error: true
      - working-directory: ${{github.workspace }}/${{ matrix.repos }}
        shell: bash
        run: mkdir -p ansible/group_vars/all
      - working-directory: ${{github.workspace }}/${{ matrix.repos }}/ansible/group_vars/all
        shell: bash
        run: |
          echo "APP_1_IMAGE_NAME: ${{ github.event.client_payload.image }}" > ${{ matrix.repos }}.yml
        
      - working-directory: ${{github.workspace }}/${{ matrix.repos }}/ansible/group_vars/all
        shell: bash
        run: |
          echo "APP_1_IMAGE_TAG: ${{ github.event.client_payload.sha }}" >> ${{ matrix.repos }}.yml
        
      - run: tar -cf ${{ matrix.repos }}.tar ansible
        working-directory: ${{github.workspace }}/${{ matrix.repos }}
      - uses: actions/upload-artifact@v2
        with:
          name: ${{ matrix.repos }}
          path: ${{github.workspace }}/${{ matrix.repos }}/${{ matrix.repos }}.tar
          
  deploy:
    needs: create_artifacts
    runs-on: ubuntu-18.04
    steps:
      - uses: actions/download-artifact@v2
      - run: mv */*.tar ./
      - run: find -name "*.tar" -exec tar -xf {} \;
      - name: Display structure of the folder files
        run: ls -R
