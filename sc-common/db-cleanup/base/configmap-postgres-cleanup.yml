apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-cleanup-configmap
  namespace: sc-common
  labels:
    app: postgres-db-cleanup
data:
  config_script.sh: |
    #!/bin/bash
    set -euo pipefail

    # Get all databases, the DB prefixes of the current namespaces and DBs that should be excluded
    existing_databases=($(psql -h "$PGHOST" -U "$PGUSER" -d postgres -t -c "SELECT datname FROM pg_database WHERE datistemplate = false;" | xargs))
    namespace_postgres_prefixes=($(kubectl get namespace -o jsonpath='{.items[*].metadata.labels.postgres_prefix}'))
    excluded_dbs=(postgres template0 template1)
    
    # Drop all DBs that are not excluded and don't have a matching prefix/namespace
    for db in ${existing_databases[@]}; do
      delete=true
      for exclude in ${excluded_dbs[@]}; do
        if [[ $db == $exclude ]]; then delete=false; fi
      done
      for prefix in ${namespace_postgres_prefixes[@]}; do
        if [[ $db == ${prefix}__* ]]; then delete=false; fi
      done
      if [[ $delete == true ]]; then
        echo "Delete $db"
        psql -h "$PGHOST" -U "$PGUSER" -d postgres -c "DROP DATABASE \"$db\";"
      else
        echo "Keep $db"
      fi
    done
